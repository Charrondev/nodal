"use strict";
const item_array_1 = require('./item_array');
const model_1 = require('./model');
const model_array_1 = require('./model_array');
class APIConstructor {
    format(obj, arrInterface) {
        if (obj instanceof Error) {
            const err = obj;
            return this.error(err.message, err.details);
        }
        if (obj instanceof model_1.default) {
            const modelArray = new model_array_1.default(obj.constructor);
            modelArray.setMeta({ total: 1, offset: 0 });
            modelArray.push(obj);
            obj = modelArray;
        }
        if (!(obj instanceof item_array_1.default)) {
            return this.spoof(obj);
        }
        return this.response(obj, arrInterface);
    }
    meta(total, count, offset, error, summary, resource) {
        if (error) {
            total = 0;
            count = 0;
            offset = 0;
            resource = null;
        }
        return {
            total,
            count,
            offset,
            error,
            summary,
            resource
        };
    }
    error(message, details) {
        return {
            meta: this.meta(0, 0, 0, { message: message, details: details }),
            data: []
        };
    }
    spoof(obj, useResource) {
        if (!(obj instanceof Array)) {
            obj = [obj];
        }
        return {
            meta: this.meta(obj.length, obj.length, 0, null, null, useResource && this.resourceFromArray(obj)),
            data: obj
        };
    }
    response(itemArray, arrInterface, useResource) {
        return {
            meta: this.meta(itemArray._meta.total, itemArray.length, itemArray._meta.offset, null, null, useResource && this.resourceFromModelArray(itemArray, arrInterface)),
            data: itemArray.toObject(arrInterface)
        };
    }
    resourceFromArray(arr) {
        function getType(v) {
            v = (v instanceof Array) ? v[0] : v;
            const typeObj = {
                boolean: 'boolean',
                string: 'string',
                number: 'float'
            };
            return typeObj[(typeof v)] || ((v instanceof Date) ? 'datetime' : 'string');
        }
        let fields = [];
        if (arr.length && arr[0] && typeof arr[0] === 'object') {
            const datum = arr[0];
            fields = Object.keys(datum).map((v, i) => {
                return {
                    name: v,
                    type: getType(datum[v]),
                    array: (v instanceof Array)
                };
            });
        }
        return {
            name: 'object',
            fields: fields
        };
    }
    resourceFromModelArray(modelArray, arrInterface) {
        return modelArray._modelConstructor.toResource(arrInterface);
    }
}
exports.APIConstructor = APIConstructor;
const API = new APIConstructor();
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = API;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdkIsS0FBSyxFQUFFLENBQUMsQ0FBQyxZQUFZLEtBQUssQ0FBQztpQkFDNUIsQ0FBQztZQUVKLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sQ0FBQztZQUNMLElBQUksRUFBRSxRQUFRO1lBQ2QsTUFBTSxFQUFFLE1BQU07U0FDZixDQUFDO0lBRUosQ0FBQztJQUVNLHNCQUFzQixDQUFDLFVBQWUsRUFBRSxZQUFpQjtRQUU5RCxNQUFNLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUUvRCxDQUFDO0FBRUgsQ0FBQztBQWxJWSxzQkFBYyxpQkFrSTFCLENBQUE7QUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO0FBRWpDO2tCQUFlLEdBQUcsQ0FBQyIsImZpbGUiOiJhcGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSXRlbUFycmF5IGZyb20gJy4vaXRlbV9hcnJheSc7XG5pbXBvcnQgTW9kZWwgZnJvbSAnLi9tb2RlbCc7XG5pbXBvcnQgTW9kZWxBcnJheSBmcm9tICcuL21vZGVsX2FycmF5JztcbmltcG9ydCB7SUFueU9iamVjdH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBBUElDb25zdHJ1Y3RvciB7XG5cbiAgcHVibGljIGZvcm1hdChvYmo6IGFueSwgYXJySW50ZXJmYWNlPzogc3RyaW5nW10pIHtcblxuICAgIGlmIChvYmogaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgY29uc3QgZXJyOiBhbnkgPSBvYmo7XG4gICAgICByZXR1cm4gdGhpcy5lcnJvcihlcnIubWVzc2FnZSwgZXJyLmRldGFpbHMpO1xuICAgIH1cblxuICAgIGlmIChvYmogaW5zdGFuY2VvZiBNb2RlbCkge1xuICAgICAgY29uc3QgbW9kZWxBcnJheTogTW9kZWxBcnJheSA9IG5ldyBNb2RlbEFycmF5KG9iai5jb25zdHJ1Y3Rvcik7XG4gICAgICBtb2RlbEFycmF5LnNldE1ldGEoe3RvdGFsOiAxLCBvZmZzZXQ6IDB9KTtcbiAgICAgIG1vZGVsQXJyYXkucHVzaChvYmopO1xuICAgICAgb2JqID0gbW9kZWxBcnJheTtcbiAgICB9XG5cbiAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBJdGVtQXJyYXkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zcG9vZihvYmopO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnJlc3BvbnNlKG9iaiwgYXJySW50ZXJmYWNlKTtcblxuICB9XG5cbiAgcHVibGljIG1ldGEodG90YWw6IG51bWJlciwgY291bnQ6IG51bWJlciwgb2Zmc2V0OiBudW1iZXIsIGVycm9yOiBhbnksIHN1bW1hcnk/OiBzdHJpbmcgfCBudWxsLCByZXNvdXJjZT86IGFueSkge1xuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICB0b3RhbCA9IDA7XG4gICAgICBjb3VudCA9IDA7XG4gICAgICBvZmZzZXQgPSAwO1xuICAgICAgcmVzb3VyY2UgPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbCxcbiAgICAgIGNvdW50LFxuICAgICAgb2Zmc2V0LFxuICAgICAgZXJyb3IsXG4gICAgICBzdW1tYXJ5LFxuICAgICAgcmVzb3VyY2VcbiAgICB9O1xuXG4gIH1cblxuICBwdWJsaWMgZXJyb3IobWVzc2FnZTogc3RyaW5nLCBkZXRhaWxzOiBzdHJpbmcpIHtcblxuICAgIHJldHVybiB7XG4gICAgICBtZXRhOiB0aGlzLm1ldGEoMCwgMCwgMCwge21lc3NhZ2U6IG1lc3NhZ2UsIGRldGFpbHM6IGRldGFpbHN9KSxcbiAgICAgIGRhdGE6IFtdXG4gICAgfTtcblxuICB9XG5cbiAgcHVibGljIHNwb29mKG9iajogYW55LCB1c2VSZXNvdXJjZT86IGJvb2xlYW4pIHtcblxuICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgb2JqID0gW29ial07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldGE6IHRoaXMubWV0YShcbiAgICAgICAgb2JqLmxlbmd0aCxcbiAgICAgICAgb2JqLmxlbmd0aCxcbiAgICAgICAgMCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgdXNlUmVzb3VyY2UgJiYgdGhpcy5yZXNvdXJjZUZyb21BcnJheShvYmopXG4gICAgICApLFxuICAgICAgZGF0YTogb2JqXG4gICAgfTtcblxuICB9XG5cbiAgcHVibGljIHJlc3BvbnNlKGl0ZW1BcnJheTogYW55LCBhcnJJbnRlcmZhY2U6IGFueSwgdXNlUmVzb3VyY2U/OiBib29sZWFuKSB7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbWV0YTogdGhpcy5tZXRhKFxuICAgICAgICBpdGVtQXJyYXkuX21ldGEudG90YWwsXG4gICAgICAgIGl0ZW1BcnJheS5sZW5ndGgsXG4gICAgICAgIGl0ZW1BcnJheS5fbWV0YS5vZmZzZXQsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIHVzZVJlc291cmNlICYmIHRoaXMucmVzb3VyY2VGcm9tTW9kZWxBcnJheShpdGVtQXJyYXksIGFyckludGVyZmFjZSlcbiAgICAgICksXG4gICAgICBkYXRhOiBpdGVtQXJyYXkudG9PYmplY3QoYXJySW50ZXJmYWNlKVxuICAgIH07XG5cbiAgfVxuXG4gIHB1YmxpYyByZXNvdXJjZUZyb21BcnJheShhcnI6IGFueVtdKSB7XG5cbiAgICBmdW5jdGlvbiBnZXRUeXBlKHY6IGFueSkge1xuICAgICAgdiA9ICh2IGluc3RhbmNlb2YgQXJyYXkpID8gdlswXSA6IHY7XG4gICAgICBjb25zdCB0eXBlT2JqOiBJQW55T2JqZWN0ID0ge1xuICAgICAgICBib29sZWFuOiAnYm9vbGVhbicsXG4gICAgICAgIHN0cmluZzogJ3N0cmluZycsXG4gICAgICAgIG51bWJlcjogJ2Zsb2F0J1xuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHR5cGVPYmpbKHR5cGVvZiB2KV0gfHwgKCh2IGluc3RhbmNlb2YgRGF0ZSkgPyAnZGF0ZXRpbWUnIDogJ3N0cmluZycpO1xuICAgIH1cblxuICAgIGxldCBmaWVsZHM6IGFueVtdID0gW107XG5cbiAgICBpZiAoYXJyLmxlbmd0aCAmJiBhcnJbMF0gJiYgdHlwZW9mIGFyclswXSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IGRhdHVtID0gYXJyWzBdO1xuICAgICAgZmllbGRzID0gT2JqZWN0LmtleXMoZGF0dW0pLm1hcCgodjogYW55LCBpOiBudW1iZXIpID0+IHtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IHYsXG4gICAgICAgICAgdHlwZTogZ2V0VHlwZShkYXR1bVt2XSksXG4gICAgICAgICAgYXJyYXk6ICh2IGluc3RhbmNlb2YgQXJyYXkpXG4gICAgICAgIH07XG5cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnb2JqZWN0JyxcbiAgICAgIGZpZWxkczogZmllbGRzXG4gICAgfTtcblxuICB9XG5cbiAgcHVibGljIHJlc291cmNlRnJvbU1vZGVsQXJyYXkobW9kZWxBcnJheTogYW55LCBhcnJJbnRlcmZhY2U6IGFueSkge1xuXG4gICAgcmV0dXJuIG1vZGVsQXJyYXkuX21vZGVsQ29uc3RydWN0b3IudG9SZXNvdXJjZShhcnJJbnRlcmZhY2UpO1xuXG4gIH1cblxufVxuXG5jb25zdCBBUEkgPSBuZXcgQVBJQ29uc3RydWN0b3IoKTtcblxuZXhwb3J0IGRlZmF1bHQgQVBJO1xuIl19
