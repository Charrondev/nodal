"use strict";
const inflect = require('i')();
/**
 * GraphQuery class that translates GraphQL to something digestible by the Composer
 * @class
 */
class GraphQuery {
    /**
     * Create a GraphQuery object
     * @param {String} str The query to execute
     * @param {Number} maxDepth The maximum depth of graph to traverse
     * @param {Nodal.Model} [Model=null] The Model to base your query around (used for testing)
     */
    constructor(str, maxDepth, mModel) {
        const parsed = this.constructor.parse(str, maxDepth);
        this.identifier = typeof parsed.structure === 'string' ?
            parsed.structure :
            Object.keys(parsed.structure)[0];
        this.name = inflect.singularize(this.identifier);
        try {
            this.Model = mModel || require(`${process.cwd()}/app/models/${this.name}.js`);
        }
        catch (e) {
            throw new Error(`Model ${this.name} does not exist.`);
        }
        this.structure = parsed.structure;
        this.joins = parsed.joins;
    }
    /**
     * Create and execute a GraphQuery object
     * @param {String} str The query to execute
     * @param {Number} maxDepth The maximum depth of graph to traverse
     * @param {Function} callback The function to execute upon completion
     */
    static query(str, maxDepth, callback) {
        let graphQuery;
        try {
            graphQuery = new GraphQuery(str, maxDepth);
        }
        catch (err) {
            callback(err);
            return false;
        }
        graphQuery.query(callback);
        return true;
    }
    /**
     * Parse syntax tree of a GraphQL query
     */
    // tslint:disable max-func-body-length
    static parseSyntaxTree(str, state, arr) {
        arr = arr || [];
        state = state || 'NAME';
        const nameRE = /[_A-Za-z][_0-9A-Za-z]*/;
        const STATES = {
            NAME: {
                skip: false,
                terminate: true,
                next: 'PROPERTYLIST',
                func: (str, arr) => {
                    const match = str.match(nameRE);
                    const name = match ? match[0] : null;
                    arr.push({
                        type: 'field',
                        data: {
                            name: name
                        }
                    });
                    const len = name ? name.length : 0;
                    return str.substr(len);
                }
            },
            PROPERTYNAME: {
                skip: false,
                terminate: true,
                next: 'PROPERTYVALUESTART',
                func: (str, arr) => {
                    const match = str.match(nameRE);
                    const name = match ? match[0] : null;
                    arr.push({
                        type: 'property',
                        data: {
                            name: name
                        }
                    });
                    const len = name ? name.length : 0;
                    return str.substr(len);
                }
            },
            PROPERTYVALUESTAR: {
                skip: false,
                terminate: false,
                next: 'PROPERTYVALUE',
                func: (str, arr) => {
                    if (str[0] !== ':') {
                        return str;
                    }
                    return str.substr(1);
                }
            },
            PROPERTYVALUE: {
                skip: false,
                terminate: false,
                next: 'PROPERTYVALUEEND',
                func: (str, arr) => {
                    const cur = arr[arr.length - 1];
                    if (str[0] !== '"') {
                        const items = [
                            { str: 'null', val: null },
                            { str: 'true', val: true },
                            { str: 'false', val: false }
                        ];
                        for (let i = 0; i < items.length; i++) {
                            const item = items[i];
                            if (str.substr(0, item.str.length) === item.str) {
                                cur.data.value = item.val;
                                return str.substr(item.str.length);
                            }
                        }
                        let value = str.match(/^[\-\+]?\d+(\.\d+|e[\-\+]?\d+)?/i);
                        if (!value) {
                            return str;
                        }
                        value = value[0];
                        cur.data.value = parseFloat(value);
                        return str.substr(value.length);
                    }
                    let i = 1;
                    while (str[i]) {
                        if (str[i] === '"') {
                            let n = 1;
                            let c = 0;
                            while (str[i - n] === '\\') {
                                c++;
                                n++;
                            }
                            if (!(c & 1)) {
                                cur.data.value = str.substring(1, i);
                                return str.substring(i + 1);
                            }
                        }
                        i++;
                    }
                    return str;
                }
            },
            PROPERTYVALUEEND: {
                skip: false,
                terminate: true,
                next: 'PROPERTYNAME',
                func: (str, arr) => {
                    if (str[0] !== ',') {
                        return str;
                    }
                    return str.substr(1);
                }
            },
            PROPERTYLIST: {
                skip: true,
                terminate: true,
                func: (str, arr) => {
                    if (str[0] !== '(') {
                        return str;
                    }
                    const cur = arr[arr.length - 1];
                    let count = 0;
                    let i = 0;
                    while (str[i]) {
                        if (str[i] === '(') {
                            count++;
                        }
                        else if (str[i] === ')') {
                            count--;
                        }
                        if (!count) {
                            break;
                        }
                        i++;
                    }
                    if (count) {
                        return str;
                    }
                    cur.data.properties = this.parseSyntaxTree(str.substring(1, i), 'PROPERTYNAME');
                    return str.substring(i + 1);
                },
                next: 'LIST'
            },
            LIS: {
                skip: true,
                terminate: true,
                next: 'NAMEEND',
                func: (str, arr) => {
                    if (str[0] !== '{') {
                        return str;
                    }
                    const cur = arr[arr.length - 1];
                    let count = 0;
                    let i = 0;
                    while (str[i]) {
                        if (str[i] === '{') {
                            count++;
                        }
                        else if (str[i] === '}') {
                            count--;
                        }
                        if (!count) {
                            break;
                        }
                        i++;
                    }
                    if (count) {
                        return str;
                    }
                    cur.data.children = this.parseSyntaxTree(str.substring(1, i), 'NAME');
                    return str.substring(i + 1);
                }
            },
            NAMEEND: {
                skip: false,
                terminate: true,
                next: 'NAME',
                func: (str, arr) => {
                    if (str[0] !== ',') {
                        return str;
                    }
                    return str.substr(1);
                }
            }
        };
        /* State machine... */
        str = str.replace(/^\s*(.*)$/m, '$1');
        if (!str) {
            if (STATES[state].terminate) {
                return arr;
            }
            else {
                throw new Error('Unexpected termination');
            }
        }
        // Execute next step...
        const next = STATES[state].func(str, arr);
        if (!STATES[state].skip && (next === str)) {
            throw new Error(`Syntax Error at or near "${str.substr(0, 20)}"`);
        }
        if (!STATES[state].next) {
            return arr;
        }
        return this.parseSyntaxTree(next, STATES[state].next, arr);
    }
    // tslint:enable max-func-body-length
    /**
     * Fully parse a GraphQL query, get necessary joins to make in SQL
     */
    static parse(str, max) {
        const joins = {};
        const tree = this.formatTree(this.parseSyntaxTree(str), max, joins);
        if (!tree.length) {
            throw new Error('Invalid query: List an object to query');
        }
        return {
            structure: tree[0],
            joins: joins
        };
    }
    /**
     * Format a parsed syntax tree in a way that the Composer expects
     */
    static formatTree(tree, max, joins, parents) {
        max = Math.max(max | 0, 0);
        joins = joins || {};
        parents = parents || [];
        const depth = parents.length;
        return tree.map(item => {
            joins[parents.concat(item.data.name).join('__')] = (item.data.properties || [])
                .filter((p) => p.type === 'property')
                .reduce((obj, p) => {
                obj[p.data.name] = p.data.value;
                return obj;
            }, {});
            if (!item.data.children) {
                return item.data.name;
            }
            if (!max || depth < max) {
                const nameObj = {};
                nameObj[item.data.name] = this.formatTree(item.data.children || [], max, joins, parents.concat(item.data.name));
                return nameObj;
            }
            else {
                return null;
            }
        }).filter(item => item);
    }
    /**
     * Query the GraphQuery object from the database
     * @param {Function} callback The function to execute upon completion
     */
    query(callback) {
        let query = this.Model.query().safeWhere(this.joins[this.identifier]);
        Object.keys(this.joins).forEach(joinName => {
            const joinNames = joinName.split('__');
            joinNames.shift();
            if (!joinNames.length) {
                return;
            }
            query = query.safeJoin(joinNames.join('__'), this.joins[joinName]);
        });
        query.end((err, models) => {
            callback(err, models, this.structure[this.identifier]);
        });
        return this;
    }
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = GraphQuery;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsQ0FBQztRQUVILEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsTUFBTTtZQUVwQixRQUFRLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBRXpELENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQztJQUVkLENBQUM7QUFFSCxDQUFDO0FBRUQ7a0JBQWUsVUFBVSxDQUFDIiwiZmlsZSI6ImdyYXBoX3F1ZXJ5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgaW5mbGVjdCA9IHJlcXVpcmUoJ2knKSgpO1xuaW1wb3J0IE1vZGVsIGZyb20gJy4vbW9kZWwnO1xuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgc2tpcDogYm9vbGVhbjtcbiAgdGVybWluYXRlOiBib29sZWFuO1xuICBuZXh0OiBzdHJpbmc7XG4gIGZ1bmM6IChzdHI6IHN0cmluZywgYXJyOiBhbnkpID0+IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElTdGF0ZXMge1xuICBba2V5OiBzdHJpbmddOiBJU3RhdGU7XG59XG5cbi8qKlxuICogR3JhcGhRdWVyeSBjbGFzcyB0aGF0IHRyYW5zbGF0ZXMgR3JhcGhRTCB0byBzb21ldGhpbmcgZGlnZXN0aWJsZSBieSB0aGUgQ29tcG9zZXJcbiAqIEBjbGFzc1xuICovXG5jbGFzcyBHcmFwaFF1ZXJ5IHtcblxuICAvLyBOZWVkZWQgdG8gdHlwZSB0aGUgY29uc3RydWN0b3JcbiAgcHJpdmF0ZSAnY29uc3RydWN0b3InOiB0eXBlb2YgR3JhcGhRdWVyeTtcbiAgcHVibGljIGlkZW50aWZpZXI6IHN0cmluZztcbiAgcHVibGljIG5hbWU6IHN0cmluZztcbiAgcHVibGljIE1vZGVsOiB0eXBlb2YgTW9kZWw7XG4gIHB1YmxpYyBzdHJ1Y3R1cmU6IGFueTtcbiAgcHVibGljIGpvaW5zOiBhbnk7XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIEdyYXBoUXVlcnkgb2JqZWN0XG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHF1ZXJ5IHRvIGV4ZWN1dGVcbiAgICogQHBhcmFtIHtOdW1iZXJ9IG1heERlcHRoIFRoZSBtYXhpbXVtIGRlcHRoIG9mIGdyYXBoIHRvIHRyYXZlcnNlXG4gICAqIEBwYXJhbSB7Tm9kYWwuTW9kZWx9IFtNb2RlbD1udWxsXSBUaGUgTW9kZWwgdG8gYmFzZSB5b3VyIHF1ZXJ5IGFyb3VuZCAodXNlZCBmb3IgdGVzdGluZylcbiAgICovXG4gIGNvbnN0cnVjdG9yKHN0cjogc3RyaW5nLCBtYXhEZXB0aDogbnVtYmVyLCBtTW9kZWw/OiB0eXBlb2YgTW9kZWwpIHtcblxuICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMuY29uc3RydWN0b3IucGFyc2Uoc3RyLCBtYXhEZXB0aCk7XG5cbiAgICB0aGlzLmlkZW50aWZpZXIgPSB0eXBlb2YgcGFyc2VkLnN0cnVjdHVyZSA9PT0gJ3N0cmluZycgP1xuICAgICAgcGFyc2VkLnN0cnVjdHVyZSA6XG4gICAgICBPYmplY3Qua2V5cyhwYXJzZWQuc3RydWN0dXJlKVswXTtcbiAgICB0aGlzLm5hbWUgPSBpbmZsZWN0LnNpbmd1bGFyaXplKHRoaXMuaWRlbnRpZmllcik7XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5Nb2RlbCA9IG1Nb2RlbCB8fCByZXF1aXJlKGAke3Byb2Nlc3MuY3dkKCl9L2FwcC9tb2RlbHMvJHt0aGlzLm5hbWV9LmpzYCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2RlbCAke3RoaXMubmFtZX0gZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgfVxuXG4gICAgdGhpcy5zdHJ1Y3R1cmUgPSBwYXJzZWQuc3RydWN0dXJlO1xuICAgIHRoaXMuam9pbnMgPSBwYXJzZWQuam9pbnM7XG5cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYW5kIGV4ZWN1dGUgYSBHcmFwaFF1ZXJ5IG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBxdWVyeSB0byBleGVjdXRlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBtYXhEZXB0aCBUaGUgbWF4aW11bSBkZXB0aCBvZiBncmFwaCB0byB0cmF2ZXJzZVxuICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gZXhlY3V0ZSB1cG9uIGNvbXBsZXRpb25cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgcXVlcnkoc3RyOiBzdHJpbmcsIG1heERlcHRoOiBudW1iZXIsIGNhbGxiYWNrOiBGdW5jdGlvbikge1xuXG4gICAgbGV0IGdyYXBoUXVlcnk6IEdyYXBoUXVlcnk7XG5cbiAgICB0cnkge1xuICAgICAgZ3JhcGhRdWVyeSA9IG5ldyBHcmFwaFF1ZXJ5KHN0ciwgbWF4RGVwdGgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBncmFwaFF1ZXJ5LnF1ZXJ5KGNhbGxiYWNrKTtcblxuICAgIHJldHVybiB0cnVlO1xuXG4gIH1cblxuICAvKipcbiAgICogUGFyc2Ugc3ludGF4IHRyZWUgb2YgYSBHcmFwaFFMIHF1ZXJ5IFxuICAgKi9cbiAgLy8gdHNsaW50OmRpc2FibGUgbWF4LWZ1bmMtYm9keS1sZW5ndGhcbiAgcHVibGljIHN0YXRpYyBwYXJzZVN5bnRheFRyZWUoc3RyOiBzdHJpbmcsIHN0YXRlPzogc3RyaW5nLCBhcnI/OiBhbnlbXSk6IGFueSB7XG5cbiAgICBhcnIgPSBhcnIgfHwgW107XG4gICAgc3RhdGUgPSBzdGF0ZSB8fCAnTkFNRSc7XG5cbiAgICBjb25zdCBuYW1lUkUgPSAvW19BLVphLXpdW18wLTlBLVphLXpdKi87XG5cbiAgICBjb25zdCBTVEFURVM6IElTdGF0ZXMgPSB7XG4gICAgICBOQU1FOiB7XG4gICAgICAgIHNraXA6IGZhbHNlLFxuICAgICAgICB0ZXJtaW5hdGU6IHRydWUsXG4gICAgICAgIG5leHQ6ICdQUk9QRVJUWUxJU1QnLFxuICAgICAgICBmdW5jOiAoc3RyOiBzdHJpbmcsIGFycjogYW55W10pID0+IHtcblxuICAgICAgICAgIGNvbnN0IG1hdGNoID0gc3RyLm1hdGNoKG5hbWVSRSk7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IG1hdGNoID8gbWF0Y2hbMF0gOiBudWxsO1xuXG4gICAgICAgICAgYXJyLnB1c2goe1xuICAgICAgICAgICAgdHlwZTogJ2ZpZWxkJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgbmFtZTogbmFtZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgY29uc3QgbGVuID0gbmFtZSA/IG5hbWUubGVuZ3RoIDogMDtcbiAgICAgICAgICByZXR1cm4gc3RyLnN1YnN0cihsZW4pO1xuXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBQUk9QRVJUWU5BTUU6IHtcbiAgICAgICAgc2tpcDogZmFsc2UsXG4gICAgICAgIHRlcm1pbmF0ZTogdHJ1ZSxcbiAgICAgICAgbmV4dDogJ1BST1BFUlRZVkFMVUVTVEFSVCcsXG4gICAgICAgIGZ1bmM6IChzdHI6IHN0cmluZywgYXJyOiBhbnkpID0+IHtcblxuICAgICAgICAgIGNvbnN0IG1hdGNoID0gc3RyLm1hdGNoKG5hbWVSRSk7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IG1hdGNoID8gbWF0Y2hbMF0gOiBudWxsO1xuXG4gICAgICAgICAgYXJyLnB1c2goe1xuICAgICAgICAgICAgdHlwZTogJ3Byb3BlcnR5JyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgbmFtZTogbmFtZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgY29uc3QgbGVuID0gbmFtZSA/IG5hbWUubGVuZ3RoIDogMDtcbiAgICAgICAgICByZXR1cm4gc3RyLnN1YnN0cihsZW4pO1xuXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBQUk9QRVJUWVZBTFVFU1RBUjoge1xuICAgICAgICBza2lwOiBmYWxzZSxcbiAgICAgICAgdGVybWluYXRlOiBmYWxzZSxcbiAgICAgICAgbmV4dDogJ1BST1BFUlRZVkFMVUUnLFxuICAgICAgICBmdW5jOiAoc3RyOiBzdHJpbmcsIGFycjogYW55KSA9PiB7XG5cbiAgICAgICAgICBpZiAoc3RyWzBdICE9PSAnOicpIHtcbiAgICAgICAgICAgIHJldHVybiBzdHI7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHN0ci5zdWJzdHIoMSk7XG5cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIFBST1BFUlRZVkFMVUU6IHtcbiAgICAgICAgc2tpcDogZmFsc2UsXG4gICAgICAgIHRlcm1pbmF0ZTogZmFsc2UsXG4gICAgICAgIG5leHQ6ICdQUk9QRVJUWVZBTFVFRU5EJyxcbiAgICAgICAgZnVuYzogKHN0cjogc3RyaW5nLCBhcnI6IGFueSkgPT4ge1xuXG4gICAgICAgICAgY29uc3QgY3VyID0gYXJyW2Fyci5sZW5ndGggLSAxXTtcblxuICAgICAgICAgIGlmIChzdHJbMF0gIT09ICdcIicpIHtcblxuICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBbXG4gICAgICAgICAgICAgIHtzdHI6ICdudWxsJywgdmFsOiBudWxsfSxcbiAgICAgICAgICAgICAge3N0cjogJ3RydWUnLCB2YWw6IHRydWV9LFxuICAgICAgICAgICAgICB7c3RyOiAnZmFsc2UnLCB2YWw6IGZhbHNlfVxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICBjb25zdCBpdGVtID0gaXRlbXNbaV07XG4gICAgICAgICAgICAgIGlmIChzdHIuc3Vic3RyKDAsIGl0ZW0uc3RyLmxlbmd0aCkgPT09IGl0ZW0uc3RyKSB7XG4gICAgICAgICAgICAgICAgY3VyLmRhdGEudmFsdWUgPSBpdGVtLnZhbDtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyLnN1YnN0cihpdGVtLnN0ci5sZW5ndGgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCB2YWx1ZTogYW55ID0gc3RyLm1hdGNoKC9eW1xcLVxcK10/XFxkKyhcXC5cXGQrfGVbXFwtXFwrXT9cXGQrKT8vaSk7XG5cbiAgICAgICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZVswXTtcbiAgICAgICAgICAgIGN1ci5kYXRhLnZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gc3RyLnN1YnN0cih2YWx1ZS5sZW5ndGgpO1xuXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbGV0IGkgPSAxO1xuICAgICAgICAgIHdoaWxlIChzdHJbaV0pIHtcblxuICAgICAgICAgICAgaWYgKHN0cltpXSA9PT0gJ1wiJykge1xuXG4gICAgICAgICAgICAgIGxldCBuID0gMTtcbiAgICAgICAgICAgICAgbGV0IGMgPSAwO1xuXG4gICAgICAgICAgICAgIHdoaWxlIChzdHJbaSAtIG5dID09PSAnXFxcXCcpIHtcbiAgICAgICAgICAgICAgICBjKys7XG4gICAgICAgICAgICAgICAgbisrO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKCEoYyAmIDEpKSB7XG4gICAgICAgICAgICAgICAgY3VyLmRhdGEudmFsdWUgPSBzdHIuc3Vic3RyaW5nKDEsIGkpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzdHIuc3Vic3RyaW5nKGkgKyAxKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGkrKztcblxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBzdHI7XG5cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIFBST1BFUlRZVkFMVUVFTkQ6IHtcbiAgICAgICAgc2tpcDogZmFsc2UsXG4gICAgICAgIHRlcm1pbmF0ZTogdHJ1ZSxcbiAgICAgICAgbmV4dDogJ1BST1BFUlRZTkFNRScsXG4gICAgICAgIGZ1bmM6IChzdHI6IHN0cmluZywgYXJyOiBhbnkpID0+IHtcblxuICAgICAgICAgIGlmIChzdHJbMF0gIT09ICcsJykge1xuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gc3RyLnN1YnN0cigxKTtcblxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgUFJPUEVSVFlMSVNUOiB7XG4gICAgICAgIHNraXA6IHRydWUsXG4gICAgICAgIHRlcm1pbmF0ZTogdHJ1ZSxcbiAgICAgICAgZnVuYzogKHN0cjogc3RyaW5nLCBhcnI6IGFueSkgPT4ge1xuXG4gICAgICAgICAgaWYgKHN0clswXSAhPT0gJygnKSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGN1ciA9IGFyclthcnIubGVuZ3RoIC0gMV07XG5cbiAgICAgICAgICBsZXQgY291bnQgPSAwO1xuICAgICAgICAgIGxldCBpID0gMDtcblxuICAgICAgICAgIHdoaWxlIChzdHJbaV0pIHtcbiAgICAgICAgICAgIGlmIChzdHJbaV0gPT09ICcoJykge1xuICAgICAgICAgICAgICBjb3VudCsrO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJbaV0gPT09ICcpJykge1xuICAgICAgICAgICAgICBjb3VudC0tO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFjb3VudCkge1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGkrKztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoY291bnQpIHtcbiAgICAgICAgICAgIHJldHVybiBzdHI7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY3VyLmRhdGEucHJvcGVydGllcyA9IHRoaXMucGFyc2VTeW50YXhUcmVlKHN0ci5zdWJzdHJpbmcoMSwgaSksICdQUk9QRVJUWU5BTUUnKTtcblxuICAgICAgICAgIHJldHVybiBzdHIuc3Vic3RyaW5nKGkgKyAxKTtcblxuICAgICAgICB9LFxuICAgICAgICBuZXh0OiAnTElTVCdcbiAgICAgIH0sXG4gICAgTElTOiB7XG4gICAgICAgIHNraXA6IHRydWUsXG4gICAgICAgIHRlcm1pbmF0ZTogdHJ1ZSxcbiAgICAgICAgbmV4dDogJ05BTUVFTkQnLFxuICAgICAgICBmdW5jOiAoc3RyOiBzdHJpbmcsIGFycjogYW55W10pID0+IHtcblxuICAgICAgICAgIGlmIChzdHJbMF0gIT09ICd7Jykge1xuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBjdXIgPSBhcnJbYXJyLmxlbmd0aCAtIDFdO1xuXG4gICAgICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgICAgICBsZXQgaSA9IDA7XG5cbiAgICAgICAgICB3aGlsZSAoc3RyW2ldKSB7XG4gICAgICAgICAgICBpZiAoc3RyW2ldID09PSAneycpIHtcbiAgICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyW2ldID09PSAnfScpIHtcbiAgICAgICAgICAgICAgY291bnQtLTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghY291bnQpIHtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpKys7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGNvdW50KSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGN1ci5kYXRhLmNoaWxkcmVuID0gdGhpcy5wYXJzZVN5bnRheFRyZWUoc3RyLnN1YnN0cmluZygxLCBpKSwgJ05BTUUnKTtcblxuICAgICAgICAgIHJldHVybiBzdHIuc3Vic3RyaW5nKGkgKyAxKTtcblxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgTkFNRUVORDoge1xuICAgICAgICBza2lwOiBmYWxzZSxcbiAgICAgICAgdGVybWluYXRlOiB0cnVlLFxuICAgICAgICBuZXh0OiAnTkFNRScsXG4gICAgICAgIGZ1bmM6IChzdHI6IHN0cmluZywgYXJyOiBhbnlbXSkgPT4ge1xuXG4gICAgICAgICAgaWYgKHN0clswXSAhPT0gJywnKSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBzdHIuc3Vic3RyKDEpO1xuXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLyogU3RhdGUgbWFjaGluZS4uLiAqL1xuXG4gICAgc3RyID0gc3RyLnJlcGxhY2UoL15cXHMqKC4qKSQvbSwgJyQxJyk7XG5cbiAgICBpZiAoIXN0cikge1xuICAgICAgaWYgKFNUQVRFU1tzdGF0ZV0udGVybWluYXRlKSB7XG4gICAgICAgIHJldHVybiBhcnI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgdGVybWluYXRpb24nKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBFeGVjdXRlIG5leHQgc3RlcC4uLlxuICAgIGNvbnN0IG5leHQgPSBTVEFURVNbc3RhdGVdLmZ1bmMoc3RyLCBhcnIpO1xuXG4gICAgaWYgKCFTVEFURVNbc3RhdGVdLnNraXAgJiYgKG5leHQgPT09IHN0cikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgU3ludGF4IEVycm9yIGF0IG9yIG5lYXIgXCIke3N0ci5zdWJzdHIoMCwgMjApfVwiYCk7XG4gICAgfVxuXG4gICAgaWYgKCFTVEFURVNbc3RhdGVdLm5leHQpIHtcbiAgICAgIHJldHVybiBhcnI7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucGFyc2VTeW50YXhUcmVlKG5leHQsIFNUQVRFU1tzdGF0ZV0ubmV4dCwgYXJyKTtcblxuICB9XG5cbiAgLy8gdHNsaW50OmVuYWJsZSBtYXgtZnVuYy1ib2R5LWxlbmd0aFxuXG4gIC8qKlxuICAgKiBGdWxseSBwYXJzZSBhIEdyYXBoUUwgcXVlcnksIGdldCBuZWNlc3Nhcnkgam9pbnMgdG8gbWFrZSBpbiBTUUxcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgcGFyc2Uoc3RyOiBzdHJpbmcsIG1heDogbnVtYmVyKSB7XG5cbiAgICBjb25zdCBqb2lucyA9IHt9O1xuICAgIGNvbnN0IHRyZWUgPSB0aGlzLmZvcm1hdFRyZWUoXG4gICAgICB0aGlzLnBhcnNlU3ludGF4VHJlZShzdHIpLFxuICAgICAgbWF4LFxuICAgICAgam9pbnNcbiAgICApO1xuXG4gICAgaWYgKCF0cmVlLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHF1ZXJ5OiBMaXN0IGFuIG9iamVjdCB0byBxdWVyeScpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdHJ1Y3R1cmU6IHRyZWVbMF0sXG4gICAgICBqb2luczogam9pbnNcbiAgICB9O1xuXG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0IGEgcGFyc2VkIHN5bnRheCB0cmVlIGluIGEgd2F5IHRoYXQgdGhlIENvbXBvc2VyIGV4cGVjdHNcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZm9ybWF0VHJlZSh0cmVlOiBhbnlbXSwgbWF4OiBudW1iZXIsIGpvaW5zOiBhbnksIHBhcmVudHM/OiBhbnkpIHtcblxuICAgIG1heCA9IE1hdGgubWF4KG1heCB8IDAsIDApO1xuICAgIGpvaW5zID0gam9pbnMgfHwge307XG4gICAgcGFyZW50cyA9IHBhcmVudHMgfHwgW107XG5cbiAgICBjb25zdCBkZXB0aCA9IHBhcmVudHMubGVuZ3RoO1xuXG4gICAgcmV0dXJuIHRyZWUubWFwKGl0ZW0gPT4ge1xuXG4gICAgICBqb2luc1twYXJlbnRzLmNvbmNhdChpdGVtLmRhdGEubmFtZSkuam9pbignX18nKV0gPSAoaXRlbS5kYXRhLnByb3BlcnRpZXMgfHwgW10pXG4gICAgICAgIC5maWx0ZXIoKHA6IGFueSkgPT4gcC50eXBlID09PSAncHJvcGVydHknKVxuICAgICAgICAucmVkdWNlKChvYmo6IGFueSwgcDogYW55KSA9PiB7XG4gICAgICAgICAgb2JqW3AuZGF0YS5uYW1lXSA9IHAuZGF0YS52YWx1ZTtcbiAgICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgICB9LCB7fSk7XG5cbiAgICAgIGlmICghaXRlbS5kYXRhLmNoaWxkcmVuKSB7XG5cbiAgICAgICAgcmV0dXJuIGl0ZW0uZGF0YS5uYW1lO1xuXG4gICAgICB9XG5cbiAgICAgIGlmICghbWF4IHx8IGRlcHRoIDwgbWF4KSB7XG5cbiAgICAgICAgY29uc3QgbmFtZU9iajogYW55ID0ge307XG4gICAgICAgIG5hbWVPYmpbaXRlbS5kYXRhLm5hbWVdID0gdGhpcy5mb3JtYXRUcmVlKFxuICAgICAgICAgIGl0ZW0uZGF0YS5jaGlsZHJlbiB8fCBbXSxcbiAgICAgICAgICBtYXgsXG4gICAgICAgICAgam9pbnMsXG4gICAgICAgICAgcGFyZW50cy5jb25jYXQoaXRlbS5kYXRhLm5hbWUpXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIG5hbWVPYmo7XG5cbiAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgIH1cblxuICAgIH0pLmZpbHRlcihpdGVtID0+IGl0ZW0pO1xuXG4gIH1cblxuICAvKipcbiAgICogUXVlcnkgdGhlIEdyYXBoUXVlcnkgb2JqZWN0IGZyb20gdGhlIGRhdGFiYXNlXG4gICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBleGVjdXRlIHVwb24gY29tcGxldGlvblxuICAgKi9cbiAgcHVibGljIHF1ZXJ5KGNhbGxiYWNrOiBGdW5jdGlvbikge1xuXG4gICAgbGV0IHF1ZXJ5ID0gdGhpcy5Nb2RlbC5xdWVyeSgpLnNhZmVXaGVyZSh0aGlzLmpvaW5zW3RoaXMuaWRlbnRpZmllcl0pO1xuXG4gICAgT2JqZWN0LmtleXModGhpcy5qb2lucykuZm9yRWFjaChqb2luTmFtZSA9PiB7XG5cbiAgICAgIGNvbnN0IGpvaW5OYW1lcyA9IGpvaW5OYW1lLnNwbGl0KCdfXycpO1xuICAgICAgam9pbk5hbWVzLnNoaWZ0KCk7XG4gICAgICBpZiAoIWpvaW5OYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBxdWVyeSA9IHF1ZXJ5LnNhZmVKb2luKGpvaW5OYW1lcy5qb2luKCdfXycpLCB0aGlzLmpvaW5zW2pvaW5OYW1lXSk7XG5cbiAgICB9KTtcblxuICAgIHF1ZXJ5LmVuZCgoZXJyLCBtb2RlbHMpID0+IHtcblxuICAgICAgY2FsbGJhY2soZXJyLCBtb2RlbHMsIHRoaXMuc3RydWN0dXJlW3RoaXMuaWRlbnRpZmllcl0pO1xuXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcztcblxuICB9XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgR3JhcGhRdWVyeTtcbiJdfQ==
