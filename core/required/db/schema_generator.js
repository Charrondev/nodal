"use strict";
const fs_1 = require('fs');
const inflect = require('i')();
class SchemaGenerator {
    constructor(db) {
        this.db = db;
        this.migrationId = null;
        this.models = {};
        this.indices = [];
        this._defaultPath = 'db/schema.json';
    }
    load(filename) {
        filename = filename || this._defaultPath;
        filename = process.cwd() + '/' + filename;
        // Need to pass an encoding to readFileSync or it could return a Buffer.
        return this.read(fs_1.default.readFileSync(filename, 'utf8'));
    }
    fetch(callback) {
        this.db.query('SELECT "schema_migrations"."schema" FROM "schema_migrations" ORDER BY "id" DESC LIMIT 1', [], ((err, result) => {
            if (err) {
                return callback(err);
            }
            result.rows && result.rows.length && this.read(result.rows[0].schema);
            callback(null);
        }));
    }
    save(filename) {
        filename = filename || this._defaultPath;
        filename = process.cwd() + '/' + filename;
        fs_1.default.writeFileSync(filename, this.generate());
        return true;
    }
    mergeProperties(columnData, properties) {
        properties = properties || {};
        const defaults = this.db.adapter.typePropertyDefaults;
        const oldProperties = this.db.adapter.getTypeProperties(columnData.type, columnData.properties) || {};
        const newProperties = {};
        this.db.adapter.typeProperties.forEach((v) => {
            if (properties.hasOwnProperty(v) && properties[v] !== defaults[v]) {
                newProperties[v] = properties[v];
            }
            else if (oldProperties.hasOwnProperty(v) && oldProperties[v] !== defaults[v]) {
                newProperties[v] = oldProperties[v];
            }
        });
        columnData.properties = newProperties;
        return columnData;
    }
    set(schema) {
        this.setMigrationId(schema.migration_id);
        this.models = schema.models || {};
        this.indices = schema.indices || [];
        return true;
    }
    setMigrationId(id) {
        this.migrationId = id;
    }
    findClass(table) {
        const models = this.models;
        return Object.keys(models).filter((v) => {
            return models[v].table === table;
        }).pop() || '';
    }
    createTable(table, arrColumnData, modelName) {
        const tableClass = modelName || inflect.classify(table);
        if (this.models[tableClass]) {
            throw new Error('Model with name "' + tableClass + '" already exists in your schema');
        }
        if (this.findClass(table)) {
            throw new Error('Table with name "' + table + '" already exists in your schema.');
        }
        arrColumnData = arrColumnData.slice();
        const columns = arrColumnData.map((v) => {
            return v.name;
        });
        if (columns.indexOf('id') === -1) {
            arrColumnData.unshift({ name: 'id', type: 'serial' });
        }
        if (columns.indexOf('created_at') === -1) {
            arrColumnData.push({ name: 'created_at', type: 'datetime' });
        }
        if (columns.indexOf('updated_at') === -1) {
            arrColumnData.push({ name: 'updated_at', type: 'datetime' });
        }
        // const defaults = this.db.adapter.typePropertyDefaults;
        arrColumnData.forEach(((columnData) => {
            this.mergeProperties(columnData);
        }));
        this.models[tableClass] = {
            table: table,
            columns: arrColumnData
        };
        return arrColumnData;
    }
    dropTable(table) {
        const tableClass = this.findClass(table);
        if (!tableClass) {
            throw new Error('Table "' + table + '" does not exist in your schema');
        }
        delete this.models[tableClass];
        return true;
    }
    renameTable(table, newTableName, renameModel, newModelName) {
        let tableClass = this.findClass(table);
        if (!tableClass) {
            throw new Error('Table "' + table + '" does not exist in your schema');
        }
        this.models[tableClass].table = newTableName;
        if (renameModel) {
            const newClass = newModelName || inflect.classify(newTableName);
            this.models[newClass] = this.models[tableClass];
            delete this.models[tableClass];
            tableClass = newClass;
        }
        return this.models[tableClass];
    }
    alterColumn(table, column, type, properties) {
        if (properties.primary_key) {
            delete properties.unique;
        }
        const models = this.models;
        const modelKey = Object.keys(models).filter((t) => {
            return models[t].table === table;
        }).pop();
        if (!modelKey) {
            throw new Error('Table "' + table + '" does not exist');
        }
        const schemaFieldData = models[modelKey].columns.filter((v) => {
            return v.name === column;
        }).pop();
        if (!schemaFieldData) {
            throw new Error('Column "' + column + '" of table "' + table + '" does not exist');
        }
        schemaFieldData.type = type;
        this.mergeProperties(schemaFieldData, properties);
        return true;
    }
    addColumn(table, column, type, properties) {
        if (properties.primary_key) {
            delete properties.unique;
        }
        const models = this.models;
        const modelKey = Object.keys(models).filter((t) => {
            return models[t].table === table;
        }).pop();
        if (!modelKey) {
            throw new Error('Table "' + table + '" does not exist');
        }
        const modelSchema = models[modelKey];
        const schemaFieldData = modelSchema.columns.filter((v) => {
            return v.name === column;
        }).pop();
        if (schemaFieldData) {
            throw new Error('Column "' + column + '" of table "' + table + '" already exists');
        }
        const columnData = {
            name: column,
            type,
            properties
        };
        modelSchema.columns.push(columnData);
        return true;
    }
    dropColumn(table, column) {
        const models = this.models;
        const modelKey = Object.keys(models).filter((t) => {
            return models[t].table === table;
        }).pop();
        if (!modelKey) {
            throw new Error('Table "' + table + '" does not exist');
        }
        const modelSchema = models[modelKey];
        const columnIndex = modelSchema.columns.map((v) => { return v.name; }).indexOf(column);
        if (columnIndex === -1) {
            throw new Error('Column "' + column + '" of table "' + table + '" does not exist');
        }
        modelSchema.columns.splice(columnIndex, 1);
        return true;
    }
    renameColumn(table, column, newColumn) {
        const models = this.models;
        const modelKey = Object.keys(models).filter((t) => {
            return models[t].table === table;
        }).pop();
        if (!modelKey) {
            throw new Error('Table "' + table + '" does not exist');
        }
        const modelSchema = models[modelKey];
        const schemaFieldData = modelSchema.columns.filter((v) => {
            return v.name === column;
        }).pop();
        if (!schemaFieldData) {
            throw new Error('Column "' + column + '" of table "' + table + '" already exists');
        }
        schemaFieldData.name = newColumn;
        return true;
    }
    createIndex(table, column, type) {
        if (this.indices.filter((v) => {
            return v.table === table && v.column === column;
        }).length) {
            throw new Error(`Index already exists on column "${column}" of table "${table}"`);
        }
        this.indices.push({ table: table, column: column, type: type });
        return true;
    }
    dropIndex(table, column) {
        this.indices = this.indices.filter((v) => {
            return !(v.table === table && v.column === column);
        });
        return true;
    }
    addForeignKey(table, referenceTable) {
        const tableClass = inflect.classify(table);
        const referenceTableClass = inflect.classify(referenceTable);
        if (!this.models[tableClass]) {
            throw new Error(`Model ${tableClass} does not exist.`);
        }
        if (!this.models[referenceTableClass]) {
            throw new Error(`Model ${referenceTableClass} does not exist.`);
        }
        return true;
    }
    dropForeignKey(table, referenceTable) {
        const tableClass = inflect.classify(table);
        const referenceTableClass = inflect.classify(referenceTable);
        if (!this.models[tableClass]) {
            throw new Error(`Model ${tableClass} does not exist.`);
        }
        if (!this.models[referenceTableClass]) {
            throw new Error(`Model ${referenceTableClass} does not exist.`);
        }
        return true;
    }
    read(json) {
        return this.set(JSON.parse(json));
    }
    generate() {
        const models = this.models;
        const indices = this.indices;
        const hasModels = !!Object.keys(models).length;
        const hasIndices = indices.length;
        let fileData = [
            '{',
            '',
            '  "migration_id": ' + this.migrationId + ((hasModels || hasIndices) ? ',' : '')
        ];
        if (hasIndices) {
            fileData = fileData.concat([
                '',
                '  "indices": [',
                indices.map((indexData) => {
                    return [
                        '    {',
                        [
                            '"table": "' + indexData.table + '"',
                            '"column": "' + indexData.column + '"',
                            (indexData.type ? '"type": "' + indexData.type + '"' : '')
                        ].filter((v) => { return !!v; }).join(', '),
                        '}'
                    ].join('');
                }).join(',\n'),
                '  ]' + (hasModels ? ',' : '')
            ]);
        }
        if (hasModels) {
            fileData = fileData.concat([
                '',
                '  "models": {',
                '',
                Object.keys(models).sort().map((t) => {
                    const curTable = models[t];
                    return [
                        '    "' + t + '": {',
                        '',
                        '      "table": "' + curTable.table + '",',
                        '',
                        '      "columns": [',
                        curTable.columns.map((columnData) => {
                            return [
                                '        ',
                                '{',
                                [
                                    '"name": "' + columnData.name + '"',
                                    '"type": "' + columnData.type + '"',
                                    columnData.properties ? '"properties": ' + JSON.stringify(columnData.properties) : ''
                                ].filter((v) => { return !!v; }).join(', '),
                                '}'
                            ].join('');
                        }).join(',\n'),
                        '      ]',
                        '',
                        '    }'
                    ].join('\n');
                }).join(',\n\n'),
                '',
                '  }'
            ]);
        }
        return fileData.concat([
            '',
            '}',
            ''
        ]).join('\n');
    }
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = SchemaGenerator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNmLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ2hCLEVBQUU7Z0JBQ0YsS0FBSzthQUNOLENBQUMsQ0FBQztRQUVMLENBQUM7UUFFRCxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUNyQixFQUFFO1lBQ0YsR0FBRztZQUNILEVBQUU7U0FDSCxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWhCLENBQUM7QUFFSCxDQUFDO0FBRUQ7a0JBQWUsZUFBZSxDQUFDIiwiZmlsZSI6ImRiL3NjaGVtYV9nZW5lcmF0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhVHlwZSwgSUFueU9iamVjdCwgSUNvbHVtblByb3BlcnRpZXMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnLi9kYXRhYmFzZSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuY29uc3QgaW5mbGVjdCA9IHJlcXVpcmUoJ2knKSgpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElJbmRpY2Uge1xuICB0YWJsZTogc3RyaW5nO1xuICBjb2x1bW46IHN0cmluZztcbiAgdHlwZTogRGF0YVR5cGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbHVtbkRhdGEge1xuICBuYW1lOiBzdHJpbmc7XG4gIHR5cGU6IERhdGFUeXBlO1xuICBwcm9wZXJ0aWVzOiBJQ29sdW1uUHJvcGVydGllcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTW9kZWwge1xuICB0YWJsZTogc3RyaW5nO1xuICBjb2x1bW5zOiBJQ29sdW1uRGF0YVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElNb2RlbHMge1xuICBbbW9kZWxLZXk6IHN0cmluZ106IElNb2RlbDtcbn1cblxuY2xhc3MgU2NoZW1hR2VuZXJhdG9yIHtcblxuICBwcml2YXRlIGRiOiBEYXRhYmFzZTtcbiAgcHJpdmF0ZSBtaWdyYXRpb25JZDogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBtb2RlbHM6IElNb2RlbHM7XG4gIHByaXZhdGUgaW5kaWNlczogSUluZGljZVtdO1xuICBwcml2YXRlIF9kZWZhdWx0UGF0aDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKGRiOiBEYXRhYmFzZSkge1xuXG4gICAgdGhpcy5kYiA9IGRiO1xuXG4gICAgdGhpcy5taWdyYXRpb25JZCA9IG51bGw7XG4gICAgdGhpcy5tb2RlbHMgPSB7fTtcbiAgICB0aGlzLmluZGljZXMgPSBbXTtcblxuICAgIHRoaXMuX2RlZmF1bHRQYXRoID0gJ2RiL3NjaGVtYS5qc29uJztcblxuICB9XG5cbiAgcHVibGljIGxvYWQoZmlsZW5hbWU6IHN0cmluZykge1xuICAgIGZpbGVuYW1lID0gZmlsZW5hbWUgfHwgdGhpcy5fZGVmYXVsdFBhdGg7XG4gICAgZmlsZW5hbWUgPSBwcm9jZXNzLmN3ZCgpICsgJy8nICsgZmlsZW5hbWU7XG4gICAgLy8gTmVlZCB0byBwYXNzIGFuIGVuY29kaW5nIHRvIHJlYWRGaWxlU3luYyBvciBpdCBjb3VsZCByZXR1cm4gYSBCdWZmZXIuXG4gICAgcmV0dXJuIHRoaXMucmVhZChmcy5yZWFkRmlsZVN5bmMoZmlsZW5hbWUsICd1dGY4JykpO1xuICB9XG5cbiAgcHVibGljIGZldGNoKGNhbGxiYWNrOiBGdW5jdGlvbikge1xuXG4gICAgdGhpcy5kYi5xdWVyeSgnU0VMRUNUIFwic2NoZW1hX21pZ3JhdGlvbnNcIi5cInNjaGVtYVwiIEZST00gXCJzY2hlbWFfbWlncmF0aW9uc1wiIE9SREVSIEJZIFwiaWRcIiBERVNDIExJTUlUIDEnLFxuICAgICAgW10sICgoZXJyOiBFcnJvciwgcmVzdWx0OiBhbnkpID0+IHtcblxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cblxuICAgICAgICByZXN1bHQucm93cyAmJiByZXN1bHQucm93cy5sZW5ndGggJiYgdGhpcy5yZWFkKHJlc3VsdC5yb3dzWzBdLnNjaGVtYSk7XG5cbiAgICAgICAgY2FsbGJhY2sobnVsbCk7XG5cbiAgICAgIH0pKTtcblxuICB9XG5cbiAgcHVibGljIHNhdmUoZmlsZW5hbWU/OiBzdHJpbmcpIHtcbiAgICBmaWxlbmFtZSA9IGZpbGVuYW1lIHx8IHRoaXMuX2RlZmF1bHRQYXRoO1xuICAgIGZpbGVuYW1lID0gcHJvY2Vzcy5jd2QoKSArICcvJyArIGZpbGVuYW1lO1xuICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZW5hbWUsIHRoaXMuZ2VuZXJhdGUoKSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgbWVyZ2VQcm9wZXJ0aWVzKGNvbHVtbkRhdGE6IGFueSwgcHJvcGVydGllcz86IGFueSkge1xuXG4gICAgcHJvcGVydGllcyA9IHByb3BlcnRpZXMgfHwge307XG5cbiAgICBjb25zdCBkZWZhdWx0cyA9IHRoaXMuZGIuYWRhcHRlci50eXBlUHJvcGVydHlEZWZhdWx0cztcblxuICAgIGNvbnN0IG9sZFByb3BlcnRpZXM6IElBbnlPYmplY3QgPSB0aGlzLmRiLmFkYXB0ZXIuZ2V0VHlwZVByb3BlcnRpZXMoY29sdW1uRGF0YS50eXBlLCBjb2x1bW5EYXRhLnByb3BlcnRpZXMpIHx8IHt9O1xuICAgIGNvbnN0IG5ld1Byb3BlcnRpZXM6IElBbnlPYmplY3QgPSB7fTtcblxuICAgIHRoaXMuZGIuYWRhcHRlci50eXBlUHJvcGVydGllcy5mb3JFYWNoKCh2OiBhbnkpID0+IHtcbiAgICAgIGlmIChwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KHYpICYmIHByb3BlcnRpZXNbdl0gIT09IGRlZmF1bHRzW3ZdKSB7XG4gICAgICAgIG5ld1Byb3BlcnRpZXNbdl0gPSBwcm9wZXJ0aWVzW3ZdO1xuICAgICAgfSBlbHNlIGlmIChvbGRQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KHYpICYmIG9sZFByb3BlcnRpZXNbdl0gIT09IGRlZmF1bHRzW3ZdKSB7XG4gICAgICAgIG5ld1Byb3BlcnRpZXNbdl0gPSBvbGRQcm9wZXJ0aWVzW3ZdO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29sdW1uRGF0YS5wcm9wZXJ0aWVzID0gbmV3UHJvcGVydGllcztcblxuICAgIHJldHVybiBjb2x1bW5EYXRhO1xuXG4gIH1cblxuICBwdWJsaWMgc2V0KHNjaGVtYToge1xuICAgIG1pZ3JhdGlvbl9pZDogc3RyaW5nO1xuICAgIG1vZGVsczogSU1vZGVscztcbiAgICBpbmRpY2VzOiBJSW5kaWNlW107XG4gIH0pIHtcblxuICAgIHRoaXMuc2V0TWlncmF0aW9uSWQoc2NoZW1hLm1pZ3JhdGlvbl9pZCk7XG4gICAgdGhpcy5tb2RlbHMgPSBzY2hlbWEubW9kZWxzIHx8IHt9O1xuICAgIHRoaXMuaW5kaWNlcyA9IHNjaGVtYS5pbmRpY2VzIHx8IFtdO1xuXG4gICAgcmV0dXJuIHRydWU7XG5cbiAgfVxuXG4gIHB1YmxpYyBzZXRNaWdyYXRpb25JZChpZDogc3RyaW5nIHwgbnVsbCkge1xuICAgIHRoaXMubWlncmF0aW9uSWQgPSBpZDtcbiAgfVxuXG4gIHB1YmxpYyBmaW5kQ2xhc3ModGFibGU6IHN0cmluZyk6IHN0cmluZyB7XG5cbiAgICBjb25zdCBtb2RlbHMgPSB0aGlzLm1vZGVscztcbiAgICByZXR1cm4gT2JqZWN0LmtleXMobW9kZWxzKS5maWx0ZXIoKHY6IHN0cmluZykgPT4ge1xuICAgICAgcmV0dXJuIG1vZGVsc1t2XS50YWJsZSA9PT0gdGFibGU7XG4gICAgfSkucG9wKCkgfHwgJyc7XG5cbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUYWJsZSh0YWJsZTogc3RyaW5nLCBhcnJDb2x1bW5EYXRhOiBhbnlbXSwgbW9kZWxOYW1lOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IHRhYmxlQ2xhc3MgPSBtb2RlbE5hbWUgfHwgaW5mbGVjdC5jbGFzc2lmeSh0YWJsZSk7XG5cbiAgICBpZiAodGhpcy5tb2RlbHNbdGFibGVDbGFzc10pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgd2l0aCBuYW1lIFwiJyArIHRhYmxlQ2xhc3MgKyAnXCIgYWxyZWFkeSBleGlzdHMgaW4geW91ciBzY2hlbWEnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5maW5kQ2xhc3ModGFibGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIHdpdGggbmFtZSBcIicgKyB0YWJsZSArICdcIiBhbHJlYWR5IGV4aXN0cyBpbiB5b3VyIHNjaGVtYS4nKTtcbiAgICB9XG5cbiAgICBhcnJDb2x1bW5EYXRhID0gYXJyQ29sdW1uRGF0YS5zbGljZSgpO1xuXG4gICAgY29uc3QgY29sdW1ucyA9IGFyckNvbHVtbkRhdGEubWFwKCh2KSA9PiB7XG4gICAgICByZXR1cm4gdi5uYW1lO1xuICAgIH0pO1xuXG4gICAgaWYgKGNvbHVtbnMuaW5kZXhPZignaWQnKSA9PT0gLTEpIHtcbiAgICAgIGFyckNvbHVtbkRhdGEudW5zaGlmdCh7IG5hbWU6ICdpZCcsIHR5cGU6ICdzZXJpYWwnIH0pO1xuICAgIH1cblxuICAgIGlmIChjb2x1bW5zLmluZGV4T2YoJ2NyZWF0ZWRfYXQnKSA9PT0gLTEpIHtcbiAgICAgIGFyckNvbHVtbkRhdGEucHVzaCh7IG5hbWU6ICdjcmVhdGVkX2F0JywgdHlwZTogJ2RhdGV0aW1lJyB9KTtcbiAgICB9XG5cbiAgICBpZiAoY29sdW1ucy5pbmRleE9mKCd1cGRhdGVkX2F0JykgPT09IC0xKSB7XG4gICAgICBhcnJDb2x1bW5EYXRhLnB1c2goeyBuYW1lOiAndXBkYXRlZF9hdCcsIHR5cGU6ICdkYXRldGltZScgfSk7XG4gICAgfVxuXG4gICAgLy8gY29uc3QgZGVmYXVsdHMgPSB0aGlzLmRiLmFkYXB0ZXIudHlwZVByb3BlcnR5RGVmYXVsdHM7XG5cbiAgICBhcnJDb2x1bW5EYXRhLmZvckVhY2goKChjb2x1bW5EYXRhOiBhbnkpID0+IHtcbiAgICAgIHRoaXMubWVyZ2VQcm9wZXJ0aWVzKGNvbHVtbkRhdGEpO1xuICAgIH0pKTtcblxuICAgIHRoaXMubW9kZWxzW3RhYmxlQ2xhc3NdID0ge1xuICAgICAgdGFibGU6IHRhYmxlLFxuICAgICAgY29sdW1uczogYXJyQ29sdW1uRGF0YVxuICAgIH07XG5cbiAgICByZXR1cm4gYXJyQ29sdW1uRGF0YTtcblxuICB9XG5cbiAgcHVibGljIGRyb3BUYWJsZSh0YWJsZTogc3RyaW5nKSB7XG5cbiAgICBjb25zdCB0YWJsZUNsYXNzID0gdGhpcy5maW5kQ2xhc3ModGFibGUpO1xuXG4gICAgaWYgKCF0YWJsZUNsYXNzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIFwiJyArIHRhYmxlICsgJ1wiIGRvZXMgbm90IGV4aXN0IGluIHlvdXIgc2NoZW1hJyk7XG4gICAgfVxuXG4gICAgZGVsZXRlIHRoaXMubW9kZWxzW3RhYmxlQ2xhc3NdO1xuXG4gICAgcmV0dXJuIHRydWU7XG5cbiAgfVxuXG4gIHB1YmxpYyByZW5hbWVUYWJsZSh0YWJsZTogc3RyaW5nLCBuZXdUYWJsZU5hbWU6IHN0cmluZywgcmVuYW1lTW9kZWw6IHN0cmluZywgbmV3TW9kZWxOYW1lOiBzdHJpbmcpIHtcblxuICAgIGxldCB0YWJsZUNsYXNzID0gdGhpcy5maW5kQ2xhc3ModGFibGUpO1xuXG4gICAgaWYgKCF0YWJsZUNsYXNzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIFwiJyArIHRhYmxlICsgJ1wiIGRvZXMgbm90IGV4aXN0IGluIHlvdXIgc2NoZW1hJyk7XG4gICAgfVxuXG4gICAgdGhpcy5tb2RlbHNbdGFibGVDbGFzc10udGFibGUgPSBuZXdUYWJsZU5hbWU7XG5cbiAgICBpZiAocmVuYW1lTW9kZWwpIHtcbiAgICAgIGNvbnN0IG5ld0NsYXNzID0gbmV3TW9kZWxOYW1lIHx8IGluZmxlY3QuY2xhc3NpZnkobmV3VGFibGVOYW1lKTtcbiAgICAgIHRoaXMubW9kZWxzW25ld0NsYXNzXSA9IHRoaXMubW9kZWxzW3RhYmxlQ2xhc3NdO1xuICAgICAgZGVsZXRlIHRoaXMubW9kZWxzW3RhYmxlQ2xhc3NdO1xuICAgICAgdGFibGVDbGFzcyA9IG5ld0NsYXNzO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLm1vZGVsc1t0YWJsZUNsYXNzXTtcblxuICB9XG5cbiAgcHVibGljIGFsdGVyQ29sdW1uKHRhYmxlOiBzdHJpbmcsIGNvbHVtbjogc3RyaW5nLCB0eXBlOiBEYXRhVHlwZSwgcHJvcGVydGllczogSUNvbHVtblByb3BlcnRpZXMpIHtcblxuICAgIGlmIChwcm9wZXJ0aWVzLnByaW1hcnlfa2V5KSB7XG4gICAgICBkZWxldGUgcHJvcGVydGllcy51bmlxdWU7XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZWxzID0gdGhpcy5tb2RlbHM7XG4gICAgY29uc3QgbW9kZWxLZXkgPSBPYmplY3Qua2V5cyhtb2RlbHMpLmZpbHRlcigodCkgPT4ge1xuICAgICAgcmV0dXJuIG1vZGVsc1t0XS50YWJsZSA9PT0gdGFibGU7XG4gICAgfSkucG9wKCk7XG5cbiAgICBpZiAoIW1vZGVsS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIFwiJyArIHRhYmxlICsgJ1wiIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NoZW1hRmllbGREYXRhID0gbW9kZWxzW21vZGVsS2V5XS5jb2x1bW5zLmZpbHRlcigodjogYW55KSA9PiB7XG4gICAgICByZXR1cm4gdi5uYW1lID09PSBjb2x1bW47XG4gICAgfSkucG9wKCk7XG5cbiAgICBpZiAoIXNjaGVtYUZpZWxkRGF0YSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb2x1bW4gXCInICsgY29sdW1uICsgJ1wiIG9mIHRhYmxlIFwiJyArIHRhYmxlICsgJ1wiIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgc2NoZW1hRmllbGREYXRhLnR5cGUgPSB0eXBlO1xuXG4gICAgdGhpcy5tZXJnZVByb3BlcnRpZXMoc2NoZW1hRmllbGREYXRhLCBwcm9wZXJ0aWVzKTtcblxuICAgIHJldHVybiB0cnVlO1xuXG4gIH1cblxuICBwdWJsaWMgYWRkQ29sdW1uKHRhYmxlOiBzdHJpbmcsIGNvbHVtbjogc3RyaW5nLCB0eXBlOiBEYXRhVHlwZSwgcHJvcGVydGllczogSUNvbHVtblByb3BlcnRpZXMpIHtcblxuICAgIGlmIChwcm9wZXJ0aWVzLnByaW1hcnlfa2V5KSB7XG4gICAgICBkZWxldGUgcHJvcGVydGllcy51bmlxdWU7XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZWxzID0gdGhpcy5tb2RlbHM7XG4gICAgY29uc3QgbW9kZWxLZXkgPSBPYmplY3Qua2V5cyhtb2RlbHMpLmZpbHRlcigodCkgPT4ge1xuICAgICAgcmV0dXJuIG1vZGVsc1t0XS50YWJsZSA9PT0gdGFibGU7XG4gICAgfSkucG9wKCk7XG5cbiAgICBpZiAoIW1vZGVsS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIFwiJyArIHRhYmxlICsgJ1wiIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZWxTY2hlbWEgPSBtb2RlbHNbbW9kZWxLZXldO1xuXG4gICAgY29uc3Qgc2NoZW1hRmllbGREYXRhID0gbW9kZWxTY2hlbWEuY29sdW1ucy5maWx0ZXIoKHYpID0+IHtcbiAgICAgIHJldHVybiB2Lm5hbWUgPT09IGNvbHVtbjtcbiAgICB9KS5wb3AoKTtcblxuICAgIGlmIChzY2hlbWFGaWVsZERhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ29sdW1uIFwiJyArIGNvbHVtbiArICdcIiBvZiB0YWJsZSBcIicgKyB0YWJsZSArICdcIiBhbHJlYWR5IGV4aXN0cycpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbHVtbkRhdGEgPSB7XG4gICAgICBuYW1lOiBjb2x1bW4sXG4gICAgICB0eXBlLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG5cbiAgICBtb2RlbFNjaGVtYS5jb2x1bW5zLnB1c2goY29sdW1uRGF0YSk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcblxuICB9XG5cbiAgcHVibGljIGRyb3BDb2x1bW4odGFibGU6IHN0cmluZywgY29sdW1uOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IG1vZGVscyA9IHRoaXMubW9kZWxzO1xuICAgIGNvbnN0IG1vZGVsS2V5ID0gT2JqZWN0LmtleXMobW9kZWxzKS5maWx0ZXIoKHQpID0+IHtcbiAgICAgIHJldHVybiBtb2RlbHNbdF0udGFibGUgPT09IHRhYmxlO1xuICAgIH0pLnBvcCgpO1xuXG4gICAgaWYgKCFtb2RlbEtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUYWJsZSBcIicgKyB0YWJsZSArICdcIiBkb2VzIG5vdCBleGlzdCcpO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsU2NoZW1hID0gbW9kZWxzW21vZGVsS2V5XTtcblxuICAgIGNvbnN0IGNvbHVtbkluZGV4ID0gbW9kZWxTY2hlbWEuY29sdW1ucy5tYXAoKHY6IGFueSkgPT4geyByZXR1cm4gdi5uYW1lOyB9KS5pbmRleE9mKGNvbHVtbik7XG5cbiAgICBpZiAoY29sdW1uSW5kZXggPT09IC0xKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbHVtbiBcIicgKyBjb2x1bW4gKyAnXCIgb2YgdGFibGUgXCInICsgdGFibGUgKyAnXCIgZG9lcyBub3QgZXhpc3QnKTtcbiAgICB9XG5cbiAgICBtb2RlbFNjaGVtYS5jb2x1bW5zLnNwbGljZShjb2x1bW5JbmRleCwgMSk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcblxuICB9XG5cbiAgcHVibGljIHJlbmFtZUNvbHVtbih0YWJsZTogc3RyaW5nLCBjb2x1bW46IHN0cmluZywgbmV3Q29sdW1uOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IG1vZGVscyA9IHRoaXMubW9kZWxzO1xuICAgIGNvbnN0IG1vZGVsS2V5ID0gT2JqZWN0LmtleXMobW9kZWxzKS5maWx0ZXIoKHQpID0+IHtcbiAgICAgIHJldHVybiBtb2RlbHNbdF0udGFibGUgPT09IHRhYmxlO1xuICAgIH0pLnBvcCgpO1xuXG4gICAgaWYgKCFtb2RlbEtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUYWJsZSBcIicgKyB0YWJsZSArICdcIiBkb2VzIG5vdCBleGlzdCcpO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsU2NoZW1hID0gbW9kZWxzW21vZGVsS2V5XTtcblxuICAgIGNvbnN0IHNjaGVtYUZpZWxkRGF0YSA9IG1vZGVsU2NoZW1hLmNvbHVtbnMuZmlsdGVyKCh2OiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB2Lm5hbWUgPT09IGNvbHVtbjtcbiAgICB9KS5wb3AoKTtcblxuICAgIGlmICghc2NoZW1hRmllbGREYXRhKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbHVtbiBcIicgKyBjb2x1bW4gKyAnXCIgb2YgdGFibGUgXCInICsgdGFibGUgKyAnXCIgYWxyZWFkeSBleGlzdHMnKTtcbiAgICB9XG5cbiAgICBzY2hlbWFGaWVsZERhdGEubmFtZSA9IG5ld0NvbHVtbjtcblxuICAgIHJldHVybiB0cnVlO1xuXG4gIH1cblxuICBwdWJsaWMgY3JlYXRlSW5kZXgodGFibGU6IHN0cmluZywgY29sdW1uOiBzdHJpbmcsIHR5cGU6IERhdGFUeXBlKSB7XG5cbiAgICBpZiAodGhpcy5pbmRpY2VzLmZpbHRlcigodikgPT4ge1xuICAgICAgcmV0dXJuIHYudGFibGUgPT09IHRhYmxlICYmIHYuY29sdW1uID09PSBjb2x1bW47XG4gICAgfSkubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IGFscmVhZHkgZXhpc3RzIG9uIGNvbHVtbiBcIiR7Y29sdW1ufVwiIG9mIHRhYmxlIFwiJHt0YWJsZX1cImApO1xuICAgIH1cblxuICAgIHRoaXMuaW5kaWNlcy5wdXNoKHsgdGFibGU6IHRhYmxlLCBjb2x1bW46IGNvbHVtbiwgdHlwZTogdHlwZSB9KTtcblxuICAgIHJldHVybiB0cnVlO1xuXG4gIH1cblxuICBwdWJsaWMgZHJvcEluZGV4KHRhYmxlOiBzdHJpbmcsIGNvbHVtbjogc3RyaW5nKSB7XG5cbiAgICB0aGlzLmluZGljZXMgPSB0aGlzLmluZGljZXMuZmlsdGVyKCh2KSA9PiB7XG4gICAgICByZXR1cm4gISh2LnRhYmxlID09PSB0YWJsZSAmJiB2LmNvbHVtbiA9PT0gY29sdW1uKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0cnVlO1xuXG4gIH1cblxuICBwdWJsaWMgYWRkRm9yZWlnbktleSh0YWJsZTogc3RyaW5nLCByZWZlcmVuY2VUYWJsZTogc3RyaW5nKSB7XG5cbiAgICBjb25zdCB0YWJsZUNsYXNzID0gaW5mbGVjdC5jbGFzc2lmeSh0YWJsZSk7XG4gICAgY29uc3QgcmVmZXJlbmNlVGFibGVDbGFzcyA9IGluZmxlY3QuY2xhc3NpZnkocmVmZXJlbmNlVGFibGUpO1xuXG4gICAgaWYgKCF0aGlzLm1vZGVsc1t0YWJsZUNsYXNzXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2RlbCAke3RhYmxlQ2xhc3N9IGRvZXMgbm90IGV4aXN0LmApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5tb2RlbHNbcmVmZXJlbmNlVGFibGVDbGFzc10pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTW9kZWwgJHtyZWZlcmVuY2VUYWJsZUNsYXNzfSBkb2VzIG5vdCBleGlzdC5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcblxuICB9XG5cbiAgcHVibGljIGRyb3BGb3JlaWduS2V5KHRhYmxlOiBzdHJpbmcsIHJlZmVyZW5jZVRhYmxlOiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IHRhYmxlQ2xhc3MgPSBpbmZsZWN0LmNsYXNzaWZ5KHRhYmxlKTtcbiAgICBjb25zdCByZWZlcmVuY2VUYWJsZUNsYXNzID0gaW5mbGVjdC5jbGFzc2lmeShyZWZlcmVuY2VUYWJsZSk7XG5cbiAgICBpZiAoIXRoaXMubW9kZWxzW3RhYmxlQ2xhc3NdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1vZGVsICR7dGFibGVDbGFzc30gZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm1vZGVsc1tyZWZlcmVuY2VUYWJsZUNsYXNzXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2RlbCAke3JlZmVyZW5jZVRhYmxlQ2xhc3N9IGRvZXMgbm90IGV4aXN0LmApO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuXG4gIH1cblxuICBwdWJsaWMgcmVhZChqc29uOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5zZXQoSlNPTi5wYXJzZShqc29uKSk7XG4gIH1cblxuICBwdWJsaWMgZ2VuZXJhdGUoKSB7XG5cbiAgICBjb25zdCBtb2RlbHMgPSB0aGlzLm1vZGVscztcbiAgICBjb25zdCBpbmRpY2VzID0gdGhpcy5pbmRpY2VzO1xuICAgIGNvbnN0IGhhc01vZGVscyA9ICEhT2JqZWN0LmtleXMobW9kZWxzKS5sZW5ndGg7XG4gICAgY29uc3QgaGFzSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoO1xuXG4gICAgbGV0IGZpbGVEYXRhID0gW1xuICAgICAgJ3snLFxuICAgICAgJycsXG4gICAgICAnICBcIm1pZ3JhdGlvbl9pZFwiOiAnICsgdGhpcy5taWdyYXRpb25JZCArICgoaGFzTW9kZWxzIHx8IGhhc0luZGljZXMpID8gJywnIDogJycpXG4gICAgXTtcblxuICAgIGlmIChoYXNJbmRpY2VzKSB7XG5cbiAgICAgIGZpbGVEYXRhID0gZmlsZURhdGEuY29uY2F0KFtcbiAgICAgICAgJycsXG4gICAgICAgICcgIFwiaW5kaWNlc1wiOiBbJyxcbiAgICAgICAgaW5kaWNlcy5tYXAoKGluZGV4RGF0YSkgPT4ge1xuICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAnICAgIHsnLFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAnXCJ0YWJsZVwiOiBcIicgKyBpbmRleERhdGEudGFibGUgKyAnXCInLFxuICAgICAgICAgICAgICAnXCJjb2x1bW5cIjogXCInICsgaW5kZXhEYXRhLmNvbHVtbiArICdcIicsXG4gICAgICAgICAgICAgIChpbmRleERhdGEudHlwZSA/ICdcInR5cGVcIjogXCInICsgaW5kZXhEYXRhLnR5cGUgKyAnXCInIDogJycpXG4gICAgICAgICAgICBdLmZpbHRlcigodikgPT4geyByZXR1cm4gISF2OyB9KS5qb2luKCcsICcpLFxuICAgICAgICAgICAgJ30nXG4gICAgICAgICAgXS5qb2luKCcnKTtcbiAgICAgICAgfSkuam9pbignLFxcbicpLFxuICAgICAgICAnICBdJyArIChoYXNNb2RlbHMgPyAnLCcgOiAnJylcbiAgICAgIF0pO1xuXG4gICAgfVxuXG4gICAgaWYgKGhhc01vZGVscykge1xuXG4gICAgICBmaWxlRGF0YSA9IGZpbGVEYXRhLmNvbmNhdChbXG4gICAgICAgICcnLFxuICAgICAgICAnICBcIm1vZGVsc1wiOiB7JyxcbiAgICAgICAgJycsXG4gICAgICAgIE9iamVjdC5rZXlzKG1vZGVscykuc29ydCgpLm1hcCgodCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGN1clRhYmxlID0gbW9kZWxzW3RdO1xuICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAnICAgIFwiJyArIHQgKyAnXCI6IHsnLFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAnICAgICAgXCJ0YWJsZVwiOiBcIicgKyBjdXJUYWJsZS50YWJsZSArICdcIiwnLFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAnICAgICAgXCJjb2x1bW5zXCI6IFsnLFxuICAgICAgICAgICAgY3VyVGFibGUuY29sdW1ucy5tYXAoKGNvbHVtbkRhdGE6IElDb2x1bW5EYXRhKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgJyAgICAgICAgJyxcbiAgICAgICAgICAgICAgICAneycsXG4gICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgJ1wibmFtZVwiOiBcIicgKyBjb2x1bW5EYXRhLm5hbWUgKyAnXCInLFxuICAgICAgICAgICAgICAgICAgJ1widHlwZVwiOiBcIicgKyBjb2x1bW5EYXRhLnR5cGUgKyAnXCInLFxuICAgICAgICAgICAgICAgICAgY29sdW1uRGF0YS5wcm9wZXJ0aWVzID8gJ1wicHJvcGVydGllc1wiOiAnICsgSlNPTi5zdHJpbmdpZnkoY29sdW1uRGF0YS5wcm9wZXJ0aWVzKSA6ICcnXG4gICAgICAgICAgICAgICAgXS5maWx0ZXIoKHYpID0+IHsgcmV0dXJuICEhdjsgfSkuam9pbignLCAnKSxcbiAgICAgICAgICAgICAgICAnfSdcbiAgICAgICAgICAgICAgXS5qb2luKCcnKTtcbiAgICAgICAgICAgIH0pLmpvaW4oJyxcXG4nKSxcbiAgICAgICAgICAgICcgICAgICBdJyxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgJyAgICB9J1xuICAgICAgICAgIF0uam9pbignXFxuJyk7XG4gICAgICAgIH0pLmpvaW4oJyxcXG5cXG4nKSxcbiAgICAgICAgJycsXG4gICAgICAgICcgIH0nXG4gICAgICBdKTtcblxuICAgIH1cblxuICAgIHJldHVybiBmaWxlRGF0YS5jb25jYXQoW1xuICAgICAgJycsXG4gICAgICAnfScsXG4gICAgICAnJ1xuICAgIF0pLmpvaW4oJ1xcbicpO1xuXG4gIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBTY2hlbWFHZW5lcmF0b3I7XG4iXX0=
