"use strict";
const item_array_js_1 = require('./item_array.js');
const async = require('async');
/*
* Array of Models, for easy conversion to Objects
* @class
*/
class ModelArray extends item_array_js_1.default {
    /*
    * Create the ModelArray with a provided Model to use as a reference.
    * @param {Array|class typeof Nodal.Model} modelConstructor Must pass the constructor for the type of ModelArray you wish to create.
    */
    constructor(modelConstructor) {
        super();
        this.Model = modelConstructor;
    }
    /*
    * Convert a normal Array into a ModelArray
    * @param {Array} arr The array of child objects
    */
    static from(arr) {
        if (!arr.length) {
            throw new Error('Cannot create ModelArray from empty Array');
        }
        const modelArray = new ModelArray(arr[0].constructor);
        modelArray.push.apply(modelArray, arr);
        return modelArray;
    }
    /*
    * Creates an Array of plain objects from the ModelArray, with properties matching an optional interface
    * @param {Array} arrInterface Interface to use for object creation for each model
    */
    toObject(arrInterface) {
        return this.map(model => model.toObject(arrInterface));
    }
    /*
    * Checks if ModelArray has a model in it
    * @param {Nodal.Model} model
    */
    has(model) {
        return this.filter(m => m.get('id') === model.get('id')).length > 0;
    }
    /*
    * Calls Model#read on each Model in the ModelArray
    * @param {Object}
    */
    readAll(data) {
        this.forEach(model => model.read(data));
        return true;
    }
    /*
    * Calls Model#set on each Model in the ModelArray
    * @param {string}
    * @param {string}
    */
    setAll(field, value) {
        this.forEach(model => model.set(field, value));
        return true;
    }
    /*
    * Destroys (deletes) all models in the ModelArray from the database
    * @param {function} callback Method to invoke upon completion
    */
    destroyAll(callback) {
        if (this.filter(m => !m.inStorage()).length) {
            return callback(new Error('Not all models are in storage'));
        }
        const db = this.Model.prototype.db;
        const params = this.map(m => m.get('id'));
        const sql = db.adapter.generateDeleteAllQuery(this.Model.table(), 'id', params);
        db.query(sql, params, (err, result) => {
            if (err) {
                return callback.call(this, new Error(err.message));
            }
            this.forEach(model => model._inStorage = false);
            callback.call(this, null);
        });
    }
    /*
    * Destroys model and cascades all deletes.
    * @param {function} callback method to run upon completion
    */
    destroyCascade(callback) {
        const db = this.Model.prototype.db;
        if (this.filter(m => !m.inStorage()).length) {
            return callback(new Error('Not all models are in storage'));
        }
        const params = this.map(model => model.get('id'));
        /*
         * TODO: Clean up this section.
         */
        let txn = [[db.adapter.generateDeleteAllQuery(this.Model.table(), 'id', params), params]];
        const children = this.Model.relationships().cascade();
        txn = txn.concat(children.map((relation) => {
            return [db.adapter.generateDeleteAllQuery(relation.getModel().table(), 'id', params, relation.joins(null, this.Model.table())), params];
        })).reverse();
        db.transaction(txn, (err, result) => {
            if (err) {
                return callback(err);
            }
            this.forEach(m => m._inStorage = false);
            callback(null);
        });
    }
    /*
    * Saves / updates all models in the ModelArray. Uses beforeSave / afterSave. Will return an error and rollback if *any* model errors out.
    * @param {function} callback returning the error and reference to self
    */
    saveAll(callback) {
        if (!this.length) {
            return callback.call(this, null, this);
        }
        /**
         * TODO: Try and use some promises here.
         */
        async.series(this.map(m => m.beforeSave.bind(m)), err => {
            if (err) {
                return callback(err);
            }
            this.__saveAll__((errr) => {
                if (err) {
                    return callback(errr, this);
                }
                async.series(this.map(m => m.afterSave.bind(m)), errrr => callback(errrr || null, this));
            });
        });
    }
    /*
    * save all models (outside of beforeSave / afterSave)
    * @param {function} callback Called with error, if applicable
    * @private
    */
    __saveAll__(callback) {
        const firstErrorModel = this.filter(m => m.hasErrors()).shift();
        if (firstErrorModel) {
            return callback.call(this, firstErrorModel.errorObject());
        }
        async.series(this.map(model => model.__verify__.bind(model)), (err) => {
            if (err) {
                return callback.call(this, err);
            }
            const db = this.Model.prototype.db;
            db.transaction(this.map(model => {
                const query = model.__generateSaveQuery__();
                return [query.sql, query.params];
            }), (errr, result) => {
                if (errr) {
                    return callback.call(this, new Error(errr.message));
                }
                this.forEach((model, index) => {
                    model.__load__(result[index].rows[0], true);
                });
                callback.call(this, null);
            });
        });
    }
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ModelArray;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEVBQUUsQ0FBQztZQUU3QyxFQUFFLENBQUMsV0FBVyxDQUNaLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSztnQkFDWixNQUFNLEtBQUssR0FBVSxLQUFLLENBQUMscUJBQXFCLEVBQUUsQ0FBQztnQkFDbkQsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbkMsQ0FBQyxDQUFDLEVBQ0YsQ0FBQyxJQUFXLEVBQUUsTUFBa0I7Z0JBRTlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ1QsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxDQUFDO2dCQUVELElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSztvQkFDeEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsQ0FBQztnQkFFSCxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUU1QixDQUFDLENBQ0YsQ0FBQztRQUVKLENBQUMsQ0FDRixDQUFDO0lBRUosQ0FBQztBQUVILENBQUM7QUFFRDtrQkFBZSxVQUFVLENBQUMiLCJmaWxlIjoibW9kZWxfYXJyYXkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRGF0YWJhc2UgZnJvbSAnLi9kYi9kYXRhYmFzZSc7XG5pbXBvcnQgSXRlbUFycmF5IGZyb20gJy4vaXRlbV9hcnJheS5qcyc7XG5pbXBvcnQgTW9kZWwgZnJvbSAnLi9tb2RlbCc7XG5pbXBvcnQgKiBhcyBhc3luYyBmcm9tICdhc3luYyc7XG5cbmltcG9ydCB7UmVsYXRpb25zaGlwUGF0aH0gZnJvbSAnLi9yZWxhdGlvbnNoaXBfZ3JhcGgnO1xuXG5pbXBvcnQge0lBbnlPYmplY3QsIFF1ZXJ5fSBmcm9tICcuL3R5cGVzJztcblxuLypcbiogQXJyYXkgb2YgTW9kZWxzLCBmb3IgZWFzeSBjb252ZXJzaW9uIHRvIE9iamVjdHNcbiogQGNsYXNzXG4qL1xuY2xhc3MgTW9kZWxBcnJheSBleHRlbmRzIEl0ZW1BcnJheTxNb2RlbD4ge1xuXG4gIHB1YmxpYyBNb2RlbDogdHlwZW9mIE1vZGVsO1xuXG4gIC8qXG4gICogQ3JlYXRlIHRoZSBNb2RlbEFycmF5IHdpdGggYSBwcm92aWRlZCBNb2RlbCB0byB1c2UgYXMgYSByZWZlcmVuY2UuXG4gICogQHBhcmFtIHtBcnJheXxjbGFzcyB0eXBlb2YgTm9kYWwuTW9kZWx9IG1vZGVsQ29uc3RydWN0b3IgTXVzdCBwYXNzIHRoZSBjb25zdHJ1Y3RvciBmb3IgdGhlIHR5cGUgb2YgTW9kZWxBcnJheSB5b3Ugd2lzaCB0byBjcmVhdGUuXG4gICovXG4gIGNvbnN0cnVjdG9yKG1vZGVsQ29uc3RydWN0b3I6IHR5cGVvZiBNb2RlbCkge1xuXG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLk1vZGVsID0gbW9kZWxDb25zdHJ1Y3RvcjtcblxuICB9XG5cbiAgLypcbiAgKiBDb252ZXJ0IGEgbm9ybWFsIEFycmF5IGludG8gYSBNb2RlbEFycmF5XG4gICogQHBhcmFtIHtBcnJheX0gYXJyIFRoZSBhcnJheSBvZiBjaGlsZCBvYmplY3RzXG4gICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShhcnI6IE1vZGVsW10pOiBNb2RlbEFycmF5IHtcblxuICAgIGlmICghYXJyLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY3JlYXRlIE1vZGVsQXJyYXkgZnJvbSBlbXB0eSBBcnJheScpO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsQXJyYXk6IE1vZGVsQXJyYXkgPSBuZXcgTW9kZWxBcnJheShhcnJbMF0uY29uc3RydWN0b3IpO1xuICAgIG1vZGVsQXJyYXkucHVzaC5hcHBseShtb2RlbEFycmF5LCBhcnIpO1xuXG4gICAgcmV0dXJuIG1vZGVsQXJyYXk7XG5cbiAgfVxuXG4gIC8qXG4gICogQ3JlYXRlcyBhbiBBcnJheSBvZiBwbGFpbiBvYmplY3RzIGZyb20gdGhlIE1vZGVsQXJyYXksIHdpdGggcHJvcGVydGllcyBtYXRjaGluZyBhbiBvcHRpb25hbCBpbnRlcmZhY2VcbiAgKiBAcGFyYW0ge0FycmF5fSBhcnJJbnRlcmZhY2UgSW50ZXJmYWNlIHRvIHVzZSBmb3Igb2JqZWN0IGNyZWF0aW9uIGZvciBlYWNoIG1vZGVsXG4gICovXG4gIHB1YmxpYyB0b09iamVjdChhcnJJbnRlcmZhY2U/OiBzdHJpbmdbXSk6IGFueSB7XG5cbiAgICByZXR1cm4gdGhpcy5tYXAobW9kZWwgPT4gbW9kZWwudG9PYmplY3QoYXJySW50ZXJmYWNlKSk7XG5cbiAgfVxuXG4gIC8qXG4gICogQ2hlY2tzIGlmIE1vZGVsQXJyYXkgaGFzIGEgbW9kZWwgaW4gaXRcbiAgKiBAcGFyYW0ge05vZGFsLk1vZGVsfSBtb2RlbFxuICAqL1xuICBwdWJsaWMgaGFzKG1vZGVsOiBNb2RlbCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmZpbHRlcihtID0+IG0uZ2V0KCdpZCcpID09PSBtb2RlbC5nZXQoJ2lkJykpLmxlbmd0aCA+IDA7XG4gIH1cblxuICAvKlxuICAqIENhbGxzIE1vZGVsI3JlYWQgb24gZWFjaCBNb2RlbCBpbiB0aGUgTW9kZWxBcnJheVxuICAqIEBwYXJhbSB7T2JqZWN0fVxuICAqL1xuICBwdWJsaWMgcmVhZEFsbChkYXRhOiBPYmplY3QpOiBib29sZWFuIHtcbiAgICB0aGlzLmZvckVhY2gobW9kZWwgPT4gbW9kZWwucmVhZChkYXRhKSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKlxuICAqIENhbGxzIE1vZGVsI3NldCBvbiBlYWNoIE1vZGVsIGluIHRoZSBNb2RlbEFycmF5XG4gICogQHBhcmFtIHtzdHJpbmd9XG4gICogQHBhcmFtIHtzdHJpbmd9XG4gICovXG4gIHB1YmxpYyBzZXRBbGwoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRoaXMuZm9yRWFjaChtb2RlbCA9PiBtb2RlbC5zZXQoZmllbGQsIHZhbHVlKSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKlxuICAqIERlc3Ryb3lzIChkZWxldGVzKSBhbGwgbW9kZWxzIGluIHRoZSBNb2RlbEFycmF5IGZyb20gdGhlIGRhdGFiYXNlXG4gICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgTWV0aG9kIHRvIGludm9rZSB1cG9uIGNvbXBsZXRpb25cbiAgKi9cbiAgcHVibGljIGRlc3Ryb3lBbGwoY2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZCB7XG5cbiAgICBpZiAodGhpcy5maWx0ZXIobSA9PiAhbS5pblN0b3JhZ2UoKSkubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2sobmV3IEVycm9yKCdOb3QgYWxsIG1vZGVscyBhcmUgaW4gc3RvcmFnZScpKTtcbiAgICB9XG5cbiAgICBjb25zdCBkYjogRGF0YWJhc2UgPSB0aGlzLk1vZGVsLnByb3RvdHlwZS5kYjtcblxuICAgIGNvbnN0IHBhcmFtczogc3RyaW5nW10gPSB0aGlzLm1hcChtID0+IG0uZ2V0KCdpZCcpKTtcbiAgICBjb25zdCBzcWw6IHN0cmluZyA9IGRiLmFkYXB0ZXIuZ2VuZXJhdGVEZWxldGVBbGxRdWVyeSh0aGlzLk1vZGVsLnRhYmxlKCksICdpZCcsIHBhcmFtcyk7XG5cbiAgICBkYi5xdWVyeShcbiAgICAgIHNxbCxcbiAgICAgIHBhcmFtcyxcbiAgICAgIChlcnI6IEVycm9yLCByZXN1bHQ6IE9iamVjdCB8IE9iamVjdFtdKSA9PiB7XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXMsIG5ldyBFcnJvcihlcnIubWVzc2FnZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5mb3JFYWNoKG1vZGVsID0+IG1vZGVsLl9pblN0b3JhZ2UgPSBmYWxzZSk7XG5cbiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBudWxsKTtcblxuICAgICAgfVxuICAgICk7XG5cbiAgfVxuXG4gIC8qXG4gICogRGVzdHJveXMgbW9kZWwgYW5kIGNhc2NhZGVzIGFsbCBkZWxldGVzLlxuICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIG1ldGhvZCB0byBydW4gdXBvbiBjb21wbGV0aW9uXG4gICovXG4gIHB1YmxpYyBkZXN0cm95Q2FzY2FkZShjYWxsYmFjazogRnVuY3Rpb24pOiB2b2lkIHtcblxuICAgIGNvbnN0IGRiOiBEYXRhYmFzZSA9IHRoaXMuTW9kZWwucHJvdG90eXBlLmRiO1xuXG4gICAgaWYgKHRoaXMuZmlsdGVyKG0gPT4gIW0uaW5TdG9yYWdlKCkpLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcignTm90IGFsbCBtb2RlbHMgYXJlIGluIHN0b3JhZ2UnKSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IHRoaXMubWFwKG1vZGVsID0+IG1vZGVsLmdldCgnaWQnKSk7XG5cbiAgICAvKlxuICAgICAqIFRPRE86IENsZWFuIHVwIHRoaXMgc2VjdGlvbi4gXG4gICAgICovXG4gICAgbGV0IHR4bjogUXVlcnkgPSBbW2RiLmFkYXB0ZXIuZ2VuZXJhdGVEZWxldGVBbGxRdWVyeSh0aGlzLk1vZGVsLnRhYmxlKCksICdpZCcsIHBhcmFtcyksIHBhcmFtc11dO1xuXG4gICAgY29uc3QgY2hpbGRyZW46IFJlbGF0aW9uc2hpcFBhdGhbXSA9IHRoaXMuTW9kZWwucmVsYXRpb25zaGlwcygpLmNhc2NhZGUoKTtcbiAgICB0eG4gPSB0eG4uY29uY2F0KFxuICAgICAgY2hpbGRyZW4ubWFwKChyZWxhdGlvbjogUmVsYXRpb25zaGlwUGF0aCkgPT4ge1xuICAgICAgICByZXR1cm4gW2RiLmFkYXB0ZXIuZ2VuZXJhdGVEZWxldGVBbGxRdWVyeShyZWxhdGlvbi5nZXRNb2RlbCgpLnRhYmxlKCksXG4gICAgICAgICAgICAgICAnaWQnLCBwYXJhbXMsIHJlbGF0aW9uLmpvaW5zKG51bGwsIHRoaXMuTW9kZWwudGFibGUoKSkpLCBwYXJhbXNdO1xuICAgICAgfSlcbiAgICApLnJldmVyc2UoKTtcblxuICAgIGRiLnRyYW5zYWN0aW9uKFxuICAgICAgdHhuLFxuICAgICAgKGVycjogRXJyb3IsIHJlc3VsdDogT2JqZWN0IHwgT2JqZWN0W10pID0+IHtcblxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZvckVhY2gobSA9PiBtLl9pblN0b3JhZ2UgPSBmYWxzZSk7XG5cbiAgICAgICAgY2FsbGJhY2sobnVsbCk7XG5cbiAgICAgIH1cbiAgICApO1xuXG4gIH1cblxuICAvKlxuICAqIFNhdmVzIC8gdXBkYXRlcyBhbGwgbW9kZWxzIGluIHRoZSBNb2RlbEFycmF5LiBVc2VzIGJlZm9yZVNhdmUgLyBhZnRlclNhdmUuIFdpbGwgcmV0dXJuIGFuIGVycm9yIGFuZCByb2xsYmFjayBpZiAqYW55KiBtb2RlbCBlcnJvcnMgb3V0LlxuICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIHJldHVybmluZyB0aGUgZXJyb3IgYW5kIHJlZmVyZW5jZSB0byBzZWxmXG4gICovXG4gIHB1YmxpYyBzYXZlQWxsKGNhbGxiYWNrOiBGdW5jdGlvbik6IEZ1bmN0aW9uIHwgdW5kZWZpbmVkIHtcblxuICAgIGlmICghdGhpcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXMsIG51bGwsIHRoaXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRPRE86IFRyeSBhbmQgdXNlIHNvbWUgcHJvbWlzZXMgaGVyZS5cbiAgICAgKi9cblxuICAgIGFzeW5jLnNlcmllcyhcbiAgICAgIHRoaXMubWFwKG0gPT4gbS5iZWZvcmVTYXZlLmJpbmQobSkpLFxuICAgICAgZXJyID0+IHtcblxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9fc2F2ZUFsbF9fKChlcnJyOiBFcnJvcikgPT4ge1xuXG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycnIsIHRoaXMpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGFzeW5jLnNlcmllcyhcbiAgICAgICAgICAgIHRoaXMubWFwKG0gPT4gbS5hZnRlclNhdmUuYmluZChtKSksXG4gICAgICAgICAgICBlcnJyciA9PiBjYWxsYmFjayhlcnJyciB8fCBudWxsLCB0aGlzKVxuICAgICAgICAgICk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgIH1cbiAgICApO1xuXG4gIH1cblxuICAvKlxuICAqIHNhdmUgYWxsIG1vZGVscyAob3V0c2lkZSBvZiBiZWZvcmVTYXZlIC8gYWZ0ZXJTYXZlKVxuICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCB3aXRoIGVycm9yLCBpZiBhcHBsaWNhYmxlXG4gICogQHByaXZhdGVcbiAgKi9cbiAgcHJpdmF0ZSBfX3NhdmVBbGxfXyhjYWxsYmFjazogRnVuY3Rpb24pOiB2b2lkIHtcblxuICAgIGNvbnN0IGZpcnN0RXJyb3JNb2RlbDogTW9kZWwgfCB1bmRlZmluZWQgPSB0aGlzLmZpbHRlcihtID0+IG0uaGFzRXJyb3JzKCkpLnNoaWZ0KCk7XG5cbiAgICBpZiAoZmlyc3RFcnJvck1vZGVsKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzLCBmaXJzdEVycm9yTW9kZWwuZXJyb3JPYmplY3QoKSk7XG4gICAgfVxuXG4gICAgYXN5bmMuc2VyaWVzKFxuICAgICAgdGhpcy5tYXAobW9kZWwgPT4gbW9kZWwuX192ZXJpZnlfXy5iaW5kKG1vZGVsKSksXG4gICAgICAoZXJyKSA9PiB7XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXMsIGVycik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkYjogRGF0YWJhc2UgPSB0aGlzLk1vZGVsLnByb3RvdHlwZS5kYjtcblxuICAgICAgICBkYi50cmFuc2FjdGlvbihcbiAgICAgICAgICB0aGlzLm1hcChtb2RlbCA9PiB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeTogUXVlcnkgPSBtb2RlbC5fX2dlbmVyYXRlU2F2ZVF1ZXJ5X18oKTtcbiAgICAgICAgICAgIHJldHVybiBbcXVlcnkuc3FsLCBxdWVyeS5wYXJhbXNdO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIChlcnJyOiBFcnJvciwgcmVzdWx0OiBJQW55T2JqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIGlmIChlcnJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXMsIG5ldyBFcnJvcihlcnJyLm1lc3NhZ2UpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mb3JFYWNoKChtb2RlbCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgbW9kZWwuX19sb2FkX18ocmVzdWx0W2luZGV4XS5yb3dzWzBdLCB0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIG51bGwpO1xuXG4gICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICB9XG4gICAgKTtcblxuICB9XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgTW9kZWxBcnJheTtcbiJdfQ==
